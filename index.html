<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√âtude photovolta√Øque</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #f7f9fc; }
    h1 { background: #5cb85c; color: white; padding: 10px; text-align: center; border-radius: 5px; }
    .identite, form, .upload-wrapper {
      background: #fff; border-radius: 6px; padding: 15px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px;
    }
    .identite { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    label { font-weight: bold; display: block; margin-bottom: 5px; }
    input, select {
      width: 100%; padding: 8px; margin-bottom: 10px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    .upload-wrapper label {
      font-weight: bold; font-size: 1rem; margin-bottom: 10px; display: block;
    }
    .upload-container {
      border: 2px dashed #d58512; background-color: #fef0d4;
      width: 600px; height: 350px;
      border-radius: 10px; margin: 0 auto;
      position: relative; overflow: hidden; cursor: pointer;
    }
    .upload-container input { display: none; }
    .upload-container img {
      width: 100%; height: 100%;
      object-fit: cover; display: none;
      position: absolute; top: 0; left: 0;
      border-radius: 10px;
    }
    .full-width {
      display: flex; gap: 15px;
      justify-content: flex-start; margin-top: 10px;
    }
    .recap {
      background: #fff3cd; padding: 15px;
      border: 1px solid #ffeeba; border-radius: 6px;
      font-size: 0.95rem; color: #856404;
      white-space: pre-line; margin: 20px 0;
    }
    button {
      padding: 10px 20px; margin-right: 10px;
      background: #28a745; color: white;
      border: none; border-radius: 6px;
      cursor: pointer; font-size: 16px;
    }
    button:hover { background: #218838; }
    table {
      width: 100%; border-collapse: collapse; margin-top: 20px;
      background: #fff; border-radius: 8px;
      overflow: hidden; box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background: #007bff; color: white; }
    .label { background: #eef3f9; font-weight: bold; text-align: left; padding-left: 10px; }
  </style>
</head>
<body>

<h1>Votre √©tude photovolta√Øque personnalis√©e</h1>

<!-- üì∏ Photo de votre maison -->
<div class="upload-wrapper">
  <label for="uploadMaison">üì∏ Photo de votre maison</label>
  <div class="upload-container" onclick="document.getElementById('uploadMaison').click()">
    <input type="file" id="uploadMaison" accept="image/*" onchange="previewImage(event, 'previewMaison')">
    <img id="previewMaison" />
  </div>
</div>

<!-- üë§ Informations client -->
<div class="identite">
  <div><label>üë§ Nom / Pr√©nom</label><input type="text" id="nom"></div>
  <div><label>üè† Adresse</label><input type="text" id="adresse"></div>
  <div><label>üìç Code postal + Ville</label><input type="text" id="cpville"></div>
  <div><label>üìû T√©l√©phone</label><input type="text" id="tel"></div>
  <div><label>‚úâÔ∏è Email</label><input type="email" id="email"></div>
  <div><label>üî¢ Point de livraison (PDL)</label><input type="text" id="pdl"></div>
</div>

<!-- ‚öôÔ∏è D√©but du formulaire -->
<form>
  <div><label>üîå Consommation annuelle (kWh)</label><input type="number" id="conso" value="9800"></div>
  <div><label>üí∂ Prix du kWh (‚Ç¨)</label><input type="number" id="prixKwh" value="0.200" step="0.001"></div>
  <div><label>‚ö° Puissance install√©e (kWc)</label>
    <select id="puissance">
      <option value="">S√©lectionnez...</option>
      <option>3 kWc</option>
      <option>4,5 kWc</option>
      <option>6 kWc</option>
      <option>9 kWc</option>
      <option>12 kWc</option>
    </select>
  </div>
</form>

<!-- üì¶ Panneaux photovolta√Øques -->
<div class="upload-wrapper">
  <label for="uploadPanneaux">üì¶ Panneaux photovolta√Øques</label>
  <div class="upload-container" onclick="document.getElementById('uploadPanneaux').click()">
    <input type="file" id="uploadPanneaux" accept="image/*" onchange="previewImage(event, 'previewPanneaux')">
    <img id="previewPanneaux" />
  </div>
</div>

<!-- üìà Performance syst√®me PV -->
<div class="upload-wrapper">
  <label for="uploadResultats">üìà Performance du syst√®me PV coupl√© au r√©seau : R√©sultats</label>
  <div class="upload-container" onclick="document.getElementById('uploadResultats').click()">
    <input type="file" id="uploadResultats" accept="image/*" onchange="previewImage(event, 'previewResultats')">
    <img id="previewResultats" />
  </div>
</div>

<!-- üîã Suite du formulaire -->
<form>
  <div><label>üîã Production photovolta√Øque annuelle (kWh)</label><input type="number" id="prod" value="6200"></div>
  <div><label>üìä % d'autoconsommation</label><input type="number" id="autoconso" value="40"></div>
  <div><label>üì¶ Co√ªt d'acheminement stockage (‚Ç¨ / kWh)</label><input type="number" id="acheminement" value="0.05" step="0.001"></div>
  <div><label>üìà Taux d‚Äôaugmentation annuelle du kWh (%)</label><input type="number" id="taux" value="5" step="0.1"></div>
  <div class="full-width">
    <button type="button" onclick="genererSimulation()">üìä G√©n√©rer le tableau</button>
    <button type="button" onclick="exporterPDF()">üìÑ Exporter la bo√Æte jaune en PDF</button>
  </div>
</form>

<!-- R√©sultats -->
<div class="recap" id="recapSimulation">Simulation en attente de g√©n√©ration.</div>
<div id="resultatSimulation"></div>

<!-- JS : T√©l√©versement et calcul -->
<script>
  function previewImage(event, id) {
    const file = event.target.files[0];
    const preview = document.getElementById(id);
    if (file && file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = function(e) {
        preview.src = e.target.result;
        preview.style.display = 'block';
      };
      reader.readAsDataURL(file);
    }
  }

  function genererSimulation() {
    const conso = parseFloat(document.getElementById('conso').value);
    const prixKwh = parseFloat(document.getElementById('prixKwh').value);
    const prod = parseFloat(document.getElementById('prod').value);
    const autoPct = parseFloat(document.getElementById('autoconso').value);
    const acheminement = parseFloat(document.getElementById('acheminement').value);
    const taux = parseFloat(document.getElementById('taux').value) / 100;
    const puissance = document.getElementById('puissance').value;

    const autoKwh = prod * autoPct / 100;
    const stockKwh = prod - autoKwh;
    const facture = conso * prixKwh;

    let recapText = `Consommation annuelle : ${conso} kWh
Prix du kWh : ${prixKwh.toFixed(3)} ‚Ç¨
Facture annuelle (hors abonnement et taxes) : ${facture.toFixed(0)} ‚Ç¨
Production annuelle : ${prod} kWh
En autoconsommation : ${autoKwh.toFixed(0)} kWh (${autoPct.toFixed(0)} %)
Surplus : ${stockKwh.toFixed(0)} kWh (${(100 - autoPct).toFixed(0)} %)`;

    if (puissance) recapText += `\nPuissance install√©e : ${puissance}`;

    document.getElementById('recapSimulation').innerText = recapText;

    let table = '<table><thead><tr><th>Ann√©e</th>';
    for (let i = 1; i <= 15; i++) table += `<th>${i}</th>`;
    table += '</tr></thead><tbody>';

    const rows = [
      { label: `Prix du kWh`, values: [] },
      { label: `Conso actuelle (${conso} kWh)`, values: [] },
      { label: `Autoconsommation (${autoKwh.toFixed(0)} kWh)`, values: [] },
      { label: `Stockage virtuel (${stockKwh.toFixed(0)} kWh)`, values: [] },
      { label: `Acheminement stockage (${acheminement.toFixed(2)} ‚Ç¨/kWh)`, values: [] },
      { label: `Nouvelle facture`, values: [] },
      { label: `√âconomie annuelle`, values: [] },
      { label: `√âconomie mensuelle`, values: [] },
    ];

    let totalEconomie = 0;
    for (let i = 0; i < 15; i++) {
      const prixAn = prixKwh * Math.pow(1 + taux, i);
      const factureAvant = conso * prixAn;
      const autoValue = autoKwh * prixAn;
      const stockValue = stockKwh * prixAn;
      const acheminementCost = stockKwh * acheminement;
      const factureApres = factureAvant - autoValue - stockValue + acheminementCost;
      const economie = factureAvant - factureApres;

      rows[0].values.push(prixAn.toFixed(3) + ' ‚Ç¨');
      rows[1].values.push(factureAvant.toFixed(0) + ' ‚Ç¨');
      rows[2].values.push('-' + autoValue.toFixed(0) + ' ‚Ç¨');
      rows[3].values.push('-' + stockValue.toFixed(0) + ' ‚Ç¨');
      rows[4].values.push('+' + acheminementCost.toFixed(0) + ' ‚Ç¨');
      rows[5].values.push(factureApres.toFixed(0) + ' ‚Ç¨');
      rows[6].values.push(economie.toFixed(0) + ' ‚Ç¨');
      rows[7].values.push(Math.round(economie / 12) + ' ‚Ç¨');
      totalEconomie += economie;
    }

    rows.forEach(row => {
      table += `<tr><td class="label">${row.label}</td>`;
      row.values.forEach(val => table += `<td>${val}</td>`);
      table += '</tr>';
    });

    table += `</tbody></table><p style="font-weight:bold; margin-top:15px;">√âconomie totale sur 15 ans : ${totalEconomie.toFixed(0)} ‚Ç¨</p>`;
    document.getElementById('resultatSimulation').innerHTML = table;
  }

  function exporterPDF() {
    const recapText = document.getElementById('recapSimulation').innerText;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(12);
    doc.text(recapText, 10, 10);
    doc.save("etude_photovoltaique.pdf");
  }
</script>

</body>
</html>
